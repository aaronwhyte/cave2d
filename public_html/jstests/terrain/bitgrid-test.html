<!DOCTYPE HTML>
<html>
<head>
  <title>BitGrid test</title>
  <script src="../../js/strings.js"></script>
  <script src="../../js/testing.js"></script>
  <script src="../../js/bits/base64.js"></script>
  <script src="../../js/bits/bitqueue.js"></script>
  <script src="../../js/bits/lempelziv.js"></script>
  <script src="../../js/bits/squisher.js"></script>
  <script src="../../js/app/changeop.js"></script>
  <script src="../../js/terrain/bitrect.js"></script>
  <script src="../../js/terrain/bitgrid.js"></script>
  <script src="../../js/geometry/vec2d.js"></script>
  <script src="../../js/geometry/segment.js"></script>
  <script src="../../js/geometry/rect.js"></script>
  <script src="../../js/url.js"></script>
  <script>
    addTest(function serializeDeserializeSomething() {
      let bg1 = new BitGrid(1);
      bg1.drawPill(new Segment(new Vec2d(-100, -200), new Vec2d(300, 0)), 50, 1);
      let json1 = bg1.toJSON();

      let bg2 = BitGrid.fromJSON(json1);
      let json2 = bg2.toJSON();
      assertStringifyEquals(json1, json2);

      let jsonStr = JSON.stringify(json1);
      let s = new Squisher();
      console.log([jsonStr.length, s.squish(jsonStr).length, jsonStr, s.squish(jsonStr)].join('\n'));
      // 7678 naive JSON
      // 2853 naive JSON squished
      // 2174 quadtree JSON
      // 1389 quadtree JSON squished
    });

    addTest(function serializeDeserializeNothing() {
      let bg1 = new BitGrid(1);
      let json1 = bg1.toJSON();

      let bg2 = BitGrid.fromJSON(json1);
      let json2 = bg2.toJSON();
      assertStringifyEquals(json1, json2);
      assertStringifyEquals(json1.cells, {});
      console.log(JSON.stringify(json1));
    });

    addTest(function drawAndUndrawPill() {
      let bg = new BitGrid(1);
      bg.drawPill(new Segment(new Vec2d(-100, -200), new Vec2d(300, 0)), 50, 1);
      bg.drawPill(new Segment(new Vec2d(-100, -200), new Vec2d(300, 0)), 50, 0);
      assertStringifyEquals(bg.cells, {});
    });

    addTest(function recordChanges() {
      let bg = new BitGrid(1);
      bg.startRecordingChanges();
      bg.drawPill(new Segment(new Vec2d(-100, 0), new Vec2d(100, 0)), 50, 1);
      bg.drawPill(new Segment(new Vec2d(0, -100), new Vec2d(0, 100)), 50, 0);
      let changeOps = bg.stopRecordingChanges();

      let snapshot = bg.toJSON();

      // undo it all
      for (let i = changeOps.length - 1; i >= 0; i--) {
        bg.applyChanges([changeOps[i].createReverse()]);
      }
      // the result should be blank.
      assertStringifyEquals(bg.cells, {});

      // redo it all
      bg.applyChanges(changeOps);
      assertStringifyEquals(bg.toJSON(), snapshot);
    });

    addTest(function oneTinyRect() {
      let bg = new BitGrid(1);
      let vec = new Vec2d(0, 0);
      bg.drawPill(new Segment(vec, vec), 0, 1);

      let cellCount = 0;
      for (let cellId in bg.cells) {
        cellCount++;
      }
      assertEquals(1, cellCount);

      for (let cellId in bg.cells) {
        let rects = bg.getRectsOfColorForCellId(1, cellId);
        assertEquals(1, rects.length);
        let rect = rects[0];
        assertEquals(0.5, rect.rad.x);
        assertEquals(0.5, rect.rad.y);
        assertEquals(0, rect.pos.x);
        assertEquals(0, rect.pos.y);
      }
    });

    addTest(function oneTripleWideRect() {
      let bg = new BitGrid(1);
      bg.drawPill(new Segment(new Vec2d(0, 0), new Vec2d(2, 0)), 0, 1);
      let cellCount = 0;
      for (let cellId in bg.cells) {
        cellCount++;
      }
      assertEquals(1, cellCount);

      for (let cellId in bg.cells) {
        let rects = bg.getRectsOfColorForCellId(1, cellId);
        assertEquals(1, rects.length);
        let rect = rects[0];
        assertEquals(1.5, rect.rad.x);
        assertEquals(0.5, rect.rad.y);
        assertEquals(1, rect.pos.x);
        assertEquals(0, rect.pos.y);
      }
    });

    addTest(function offsetPillOneTinyRect() {
      let bg = new BitGrid(1);
      let vec = new Vec2d(-0.1, -0.1);
      // A cell is painted only if its center is inside the pill.
      bg.drawPill(new Segment(vec, vec), 1.0001 * 0.1 * Math.sqrt(2), 1);

      let cellCount = 0;
      for (let cellId in bg.cells) {
        cellCount++;
      }
      assertEquals(1, cellCount);

      for (let cellId in bg.cells) {
        let rects = bg.getRectsOfColorForCellId(1, cellId);
        assertEquals(1, rects.length);
        let rect = rects[0];
        assertEquals(0.5, rect.rad.x);
        assertEquals(0.5, rect.rad.y);
        assertEquals(0, rect.pos.x);
        assertEquals(0, rect.pos.y);
      }
    });

    addTest(function betweenPointsZeroRects() {
      let bg = new BitGrid(1);
      let p0 = new Vec2d(-100, 0.5);
      let p1 = new Vec2d(100, 0.5);
      bg.drawPill(new Segment(vec, vec), 0.49, 1);

      let cellCount = 0;
      for (let cellId in bg.cells) {
        cellCount++;
      }
      assertEquals(0, cellCount);
    });

  </script>
</head>
<body onload="runTests()"></body>
</html>
